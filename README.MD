# üè¶ Bank Account Service

Microservicio REST para gestionar **cuentas bancarias**, pensado como ejercicio t√©cnico, pero construido con criterios de proyecto real:

- Modelo de dominio claro (BankAccount) y arquitectura **hexagonal**.
- Persistencia en **H2 en memoria** mediante Spring Data JPA.
- Exposici√≥n de un CRUD completo y un endpoint adicional de **‚Äúresumen de cuenta‚Äù** que consume el propio API.
- Manejo centralizado de errores con respuestas JSON homog√©neas.
- Logging estructurado en **JSON**, listo para ser enviado a un stack **ELK** (Elasticsearch + Logstash + Kibana).
- Uso moderado de **Lombok** para reducir c√≥digo repetitivo.

---

## 1. Stack y versiones

- **Java** 21  
- **Spring Boot** 3.5.7  
- **Spring Web / RestClient**
- **Spring Data JPA + H2** (BD en memoria)
- **Jakarta Validation** (`@Valid`, `@NotBlank`, etc.)
- **Lombok** (getters/setters/builders)
- **Logback** + `logstash-logback-encoder` (logs JSON)
- **Logbook (Zalando)** para trazas HTTP
- **ELK 9.2.1** (Elasticsearch + Logstash + Kibana) v√≠a Docker (opcional)
- JUnit 5 + Mockito (tests de dominio y de integraci√≥n, opcionales)

> üí° Si abr√≠s el proyecto en un IDE (Eclipse/IntelliJ/STS) vas a necesitar:
> - plugin de **Lombok** instalado  
> - **annotation processing** habilitado  
> De lo contrario, el c√≥digo puede compilar por Maven pero verse con errores en el editor.

---

## 2. Qu√© resuelve este microservicio

### Funcionalidad de negocio

- Alta, baja l√≥gica, modificaci√≥n y consulta de **cuentas bancarias**.
- Cada cuenta incluye:
  - `accountNumber`, `cbu`, `ownerName`, `ownerDocument`
  - `currency`, `balance`, `status`, `branchCode`
  - `createdAt`, `updatedAt`
- Reglas de negocio:
  - El **CBU debe ser √∫nico** (validaci√≥n en servicio + constraint en BD).
  - El DELETE sobre `/accounts/{id}` realiza un **cierre l√≥gico** (`status = CLOSED`), no un borrado f√≠sico.
  - El endpoint `/accounts/{id}/summary` calcula una vista simplificada de la cuenta e incorpora una se√±al de riesgo si el saldo es bajo.

### Endpoint que se llama a s√≠ mismo

El enunciado ped√≠a que un endpoint del microservicio consuma otro endpoint del mismo servicio.  
En este caso:

- `GET /api/v1/accounts/{id}/summary`
- Internamente usa **RestClient** para llamar a:
  - `GET /api/v1/accounts/{id}`
- A partir de esa respuesta se construye un `AccountSummaryResponse` con:
  - datos b√°sicos de la cuenta
  - flag `lowBalanceRisk` (`true` si el saldo es menor a cierto umbral).

---

## 3. Arquitectura y organizaci√≥n de c√≥digo

Se sigue un esquema **Ports & Adapters (arquitectura hexagonal)** para separar dominio de infraestructura.

```text
com.bank_services.account
 ‚îú‚îÄ domain
 ‚îÇ   ‚îú‚îÄ model        # BankAccount, enums (Currency, AccountStatus)
 ‚îÇ   ‚îú‚îÄ port         # AccountRepositoryPort (puerto de salida)
 ‚îÇ   ‚îú‚îÄ service      # AccountService con reglas de negocio
 ‚îÇ   ‚îî‚îÄ exception    # Excepciones: ResourceNotFound, DuplicateResource
 ‚îú‚îÄ application
 ‚îÇ   ‚îî‚îÄ dto          # DTOs de request/response para la API p√∫blica
 ‚îî‚îÄ infrastructure
     ‚îú‚îÄ persistence  # JPA: BankAccountEntity, SpringDataAccountRepository,
     ‚îÇ               #      AccountRepositoryAdapter (adapter del puerto)
     ‚îú‚îÄ web          # AccountController + SelfAccountClient (RestClient)
     ‚îú‚îÄ error        # ApiError + GlobalExceptionHandler
     ‚îú‚îÄ config       # Configuraci√≥n de Logbook, etc.
     ‚îî‚îÄ logging      # (si aplica) clases auxiliares para logging

### Dominio

- `BankAccount`:
  - implementado con **Lombok** (`@Data`, `@Builder`, etc.) para mantener el modelo limpio.
  - m√©todos de negocio:
    - `updateFrom(...)` para aplicar cambios sin perder el estado cr√≠tico (por ejemplo, `status`).
    - `close()` para cambiar a `CLOSED` y actualizar timestamps.
- `AccountService`:
  - encapsula la l√≥gica de negocio:
    - valida unicidad de CBU.
    - traduce ‚Äúno encontrado‚Äù en `ResourceNotFoundException`.
    - aplica reglas en `create`, `update`, `delete`.

### Persistencia

- `BankAccountEntity`:
  - entidad JPA mapeada sobre la tabla `bank_accounts`.
  - `@GeneratedValue(strategy = GenerationType.UUID)` para IDs.
  - constraint √∫nico en `cbu`.
- `AccountRepositoryPort`:
  - expone operaciones de dominio (`save`, `findById`, `existsByCbu`, etc.).
- `AccountRepositoryAdapter`:
  - adapta `AccountRepositoryPort` a un `JpaRepository`.
  - se encarga de mapear `BankAccount` ‚Üî `BankAccountEntity`.

### API REST

- `AccountController`:
  - expone CRUD en `/api/v1/accounts`.
  - recibe/retorna DTOs (`BankAccountRequest`, `BankAccountResponse`).
- Manejo de errores:
  - `GlobalExceptionHandler` con `@ControllerAdvice`.
  - Todas las respuestas de error salen como `ApiError` (timestamp, status, error, message, path).

---

## 4. Endpoints principales

Base: `http://localhost:8080/api/v1/accounts`

| M√©todo | URL         | Descripci√≥n                         |
|--------|-------------|-------------------------------------|
| POST   | `/`         | Crear cuenta                        |
| GET    | `/`         | Listar todas las cuentas            |
| GET    | `/{id}`     | Obtener cuenta por ID               |
| PUT    | `/{id}`     | Actualizar cuenta                   |
| DELETE | `/{id}`     | Cerrar cuenta (status = CLOSED)     |
| GET    | `/{id}/summary` | Resumen de cuenta (self-call REST) |

### Ejemplos r√°pidos con `curl` (Windows CMD)

**Crear:**

```bat
curl -X POST "http://localhost:8080/api/v1/accounts" ^
  -H "Content-Type: application/json" ^
  -d "{""accountNumber"":""ACC-001"",""cbu"":""1230000100000000000011"",""ownerName"":""Juan Perez"",""ownerDocument"":""30123456"",""currency"":""ARS"",""balance"":500.00,""branchCode"":""001""}"

**Resumen de cuenta:**

```bat
curl -X GET "http://localhost:8080/api/v1/accounts/{ID}/summary"

## 5. Base de datos H2

La aplicaci√≥n utiliza **H2 en memoria**, por lo que no requiere instalar ninguna base externa para ejecutarse.

- **Consola H2:**  
  http://localhost:8080/h2-console

- **Credenciales por defecto:**  
  - JDBC URL: `jdbc:h2:mem:bankdb`  
  - Usuario: `sa`  
  - Contrase√±a: *(vac√≠a)*

El esquema se genera autom√°ticamente a partir de la entidad JPA (`BankAccountEntity`).

---

## 6. Logging y Observabilidad

### Logging interno

La aplicaci√≥n usa:

- **Logback** con encoder JSON (`LogstashEncoder`)
- **Logbook (Zalando)** para registrar:
  - m√©todo HTTP
  - URL
  - cuerpo enviado/recibido
  - tiempo de respuesta
  - c√≥digo de estado

Esto permite analizar peticiones sin necesidad de herramientas externas.

### Integraci√≥n opcional con ELK

El proyecto incluye un stack b√°sico **ELK (Elasticsearch + Logstash + Kibana)** para visualizar logs estructurados.

### C√≥mo levantar ELK

En la ra√≠z del proyecto hay una carpeta `elk/` con:

- `docker-compose.yml`
- `logstash/pipeline/logstash.conf`

Ejecutar:

```bash
cd elk
docker compose up -d


Servicios disponibles:

- Elasticsearch:  http://localhost:9200
- Kibana:         http://localhost:5601
- Logstash (TCP): puerto 5000

#### Visualizaci√≥n en Kibana

1. Ir a: http://localhost:5601  
2. Abrir la secci√≥n **Discover**  
3. Crear un *Data View* con el patr√≥n:

   bank-logs-*

Los logs enviados por la aplicaci√≥n aparecer√°n autom√°ticamente all√≠.

---

## 7. C√≥mo ejecutar la aplicaci√≥n

### Requisitos

- Java 21  
- Maven 3.9+  
- Docker Desktop (solo si vas a usar ELK)

### Ejecutar en modo desarrollo

mvn spring-boot:run -DskipTests

### Construir y ejecutar el JAR

mvn clean package -DskipTests
java -jar target/bank-account-service-0.0.1-SNAPSHOT.jar

La API se expone en:

http://localhost:8080/api/v1/accounts

### Levantar ELK (opcional)

cd elk
docker compose up -d

---

## 8. Pruebas automatizadas (opcional)

El proyecto contempla dos tipos de pruebas:

### Tests de dominio (JUnit + Mockito)

Verifican, entre otros:

- Control de CBU duplicado  
- Comportamiento de `create`, `update`, `getById`  
- L√≥gica de cierre de cuenta (`close()`)

### Tests de integraci√≥n (SpringBootTest + TestRestTemplate)

Prueban:

- Flujo POST + GET end-to-end  
- Persistencia real sobre H2  
- C√≥digos HTTP esperados (200, 201, 404, 409)

Ejecuci√≥n de pruebas:

mvn clean test

---

## 9. L√≠neas de mejora

Algunas extensiones naturales del proyecto:

- Documentaci√≥n autom√°tica de la API con **OpenAPI / Swagger UI**  
- Autenticaci√≥n y autorizaci√≥n (JWT + Spring Security)  
- Filtros y paginaci√≥n en endpoints de consulta  
- M√©tricas t√©cnicas y de negocio con Micrometer + Prometheus/Grafana  
- Extensi√≥n del dominio a:
  - Movimientos bancarios  
  - Clientes  
  - Transferencias  
  - Integraci√≥n con otros microservicios reutilizando la misma arquitectura hexagonal
